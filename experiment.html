<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>驾驶人感知能力测试问卷</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <div class="experiment-container">
        <div class="header">
            <h1>感知能力测试部分</h1>
            <p>感知到风险即点击按钮</p>
        </div>

        <div class="video-container">
            <div class="white-overlay"></div>
            <video id="videoPlayer" controls>
                您的浏览器不支持视频播放。
            </video>
        </div>
        <!-- 新增按钮容器 -->
        <div class="button-container">
            <button id="actionBtn" class="glass-button">
               <span class="button-icon">⏺</span>
               感觉到风险
            </button>
       </div>
    </div>

    <script>
        // 这里的视频文件名数组
        const videos = ['stop1.mp4', 'cutin1.mp4', 'ped3.mp4',
                        '1.mp4', '2.mp4', '3.mp4',
                        'stop1_eve.mp4', 'cutin1_fog.mp4', 'ped1_fog.mp4', 'cutin3.mp4', 'ped3.mp4',
                        'stop2.mp4', 'cutin2_eve.mp4', 'ped2.mp4', 'stop1_t.mp4', 'ped3_fog.mp4',
                        '1_real.mp4', '2_real.mp4', '3_real.mp4', 'cutin3_t.mp4',
                        'stop1_fog.mp4', 'cutin2.mp4', 'ped2_fog.mp4', 'cutin3_eve.mp4',
                        'cutin3_fog.mp4', 'stop2_fog.mp4', 'ped1_eve.mp4', 'cutin1_t.mp4', 'stop2_t.mp4', 'cutin1_eve.mp4',
                        'stop2_eve.mp4', 'cutin2_fog.mp4', 'ped2_eve.mp4', 'cutin2_t.mp4', 'ped3_eve.mp4']; 
        let currentIndex = 0;
        const videoPlayer = document.getElementById('videoPlayer');
        const overlay = document.querySelector('.white-overlay');
        let hasClicked = false;

        // 播放下一个视频
        function playNext() {
            if (currentIndex >= videos.length) {
                showCompletion();
                return;
            }

            // 设置视频路径，确保路径指向 GitHub Pages 上的正确位置
            videoPlayer.src = `videos/${videos[currentIndex]}`;  // 视频在 /videos 文件夹下
            videoPlayer.play();
            currentIndex++;
            hasClicked = false;
        }

        // 设置按钮状态（禁用或启用）
        function setButtonState(disabled) {
            const btn = document.getElementById('actionBtn');
            btn.disabled = disabled;
            btn.style.pointerEvents = disabled ? 'none' : 'auto';
        }

        // 视频播放结束时的处理
        function handleVideoEnd() {
            // 禁用按钮
            setButtonState(true);

            // 显示白屏
            overlay.classList.add('active');

            // 发送记录（如果用户没有点击）
            if (!hasClicked) {
                fetch('/record', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        user_id: "{{ session.user_id }}",  // 这里是 Flask 模板语法，实际部署时替换
                        video: videos[currentIndex - 1],
                        current_frame: null
                    })
                }).catch(error => {
                    console.error('Error recording data:', error);
                });
            }

            // 3秒后继续
            setTimeout(() => {
                overlay.classList.remove('active');
                setButtonState(false); // 恢复按钮
                playNext();
            }, 3000);
        }

        // 处理按钮点击
        document.getElementById('actionBtn').addEventListener('click', () => {
            // 立即禁用按钮
            setButtonState(true);
            // 立即暂停视频
            videoPlayer.pause();
            hasClicked = true;
            // 显示白屏
            overlay.classList.add('active');

            // 发送点击记录
            fetch('/record', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    user_id: "{{ session.user_id }}",  // 这里是 Flask 模板语法，实际部署时替换
                    video: videos[currentIndex - 1],
                    current_frame: videoPlayer.currentTime.toFixed(3)
                })
            }).catch(error => {
                console.error('Error recording data:', error);
            });

            // 3秒后继续
            setTimeout(() => {
                overlay.classList.remove('active');
                setButtonState(false); // 恢复按钮
                playNext();
            }, 3000);
        });

        // 视频播放结束时触发
        videoPlayer.addEventListener('ended', handleVideoEnd);
        playNext(); // 初始化播放

        // 显示实验完成的页面
        function showCompletion() {
            document.body.innerHTML = `
                <div class="completion-screen">
                    <h2>实验完成</h2>
                    <p>已记录所有数据，感谢您的参与！</p>
                </div>
            `;
        }
    </script>
    <a href="index.html">Return to Home</a>
</body>
</html>


